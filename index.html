<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing - TibbeTech (Fully Dynamic Display)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/color-thief-browser@2.0.2/js/color-thief.min.js"></script>

    <style>
        /* --- Google Font Import --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap');

        /* --- Variable Definitions & Body Styling --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dynamic-bg-color, #030712); /* Use a dynamic CSS variable as fallback */
            background-image: radial-gradient(ellipse 80% 80% at 50% -20%,rgba(120,119,198,0.3),hsla(0,0%,100%,0));
            overflow: hidden;
            transition: background-color 1.5s ease-in-out; /* Added transition for smooth color change */
        }

        /* --- Static Animated Aurora Background (The primary color change target) --- */
        body::before, body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
            background-size: 400% 400%;
            transition: background 1.5s ease-in-out;
            filter: blur(100px);
        }

        body::before {
            background-image: var(--aurora-gradient-1, linear-gradient(315deg, #f97316 0%, #7c3aed 74%));
            animation: AuroraAnimation 20s ease infinite;
        }

        body::after {
            background-image: var(--aurora-gradient-2, linear-gradient(45deg, #ef4444 0%, #3b82f6 74%));
            animation: AuroraAnimation 25s ease infinite reverse;
        }

        @keyframes AuroraAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Full-Page Content Wrapper (Unchanged) --- */
        .now-playing-content {
            padding: 2rem;
            width: 100%;
            max-width: 1400px;
            margin: auto;
        }

        /* --- Progress Bar Enhancement (Uses dynamic colors) --- */
        .progress-bar-fill {
            box-shadow: 0 0 10px 2px var(--progress-glow-color, #f97316);
        }

        /* --- "CD/VINYL" Tag Refinement (Unchanged) --- */
        .manual-play-tag {
            background: linear-gradient(45deg, #ec4899, #d946ef);
            transform: rotate(0deg);
            font-weight: 800;
            font-size: 0.875rem;
            padding: 0.35rem 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
            animation: none;
            backdrop-filter: blur(5px);
        }

        /* --- Dynamic Text Glow Enhancement --- */
        .text-glow {
            text-shadow:
                    0 0 15px rgba(0, 0, 0, 0.9),
                    0 0 30px var(--text-glow-color, rgba(255, 255, 255, 0.4));
        }

        /* --- Dynamic Album Art Glow --- */
        .album-art-glow {
            box-shadow: 0 0 50px 10px var(--album-art-glow-color, rgba(249, 115, 22, 0.7));
        }

    </style>
</head>
<body class="min-h-screen">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // --- Configuration ---
    const API_URL = "https://spotitech.tibbetech.com/listeningto";
    const UPDATE_INTERVAL = 15000;

    // --- Utility to darken an RGB color ---
    const darkenRgb = (rgbArray, factor = 0.1) => { // Lower factor for darker result
        return rgbArray.map(c => Math.max(0, Math.floor(c * factor)));
    };


    // --- Custom Hook for API Fetching (Unchanged) ---
    const useNowPlaying = () => {
        const [trackData, setTrackData] = useState(null);
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);

        const fetchData = async () => {
            try {
                const response = await fetch(`${API_URL}?cacheBuster=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                setTrackData(data);
                setIsLoading(false);
            } catch (e) {
                console.error("Failed to fetch current track:", e);
                setError(e.message);
                setIsLoading(false);
            }
        };

        useEffect(() => {
            fetchData();
            const intervalId = setInterval(fetchData, UPDATE_INTERVAL);
            return () => clearInterval(intervalId);
        }, []);

        return { trackData, isLoading, error };
    };

    // --- The Main Component ---
    const NowPlayingSite = () => {
        const { trackData, isLoading, error } = useNowPlaying();
        const [palette, setPalette] = useState(null);
        const [currentProgressPercent, setCurrentProgressPercent] = useState(0);
        const [lastUpdateTimestamp, setLastUpdateTimestamp] = useState(Date.now());


        // --- Color Extraction & Progress Initialization Logic (FIXED DEPENDENCY) ---
        useEffect(() => {
            // Reset palette and progress when a new song is detected
            setPalette(null);

            if (trackData && trackData.albumArt && trackData.playing && window.ColorThief) {
                const colorThief = new ColorThief();
                const img = new Image();

                // IMPORTANT: This is the critical part for cross-origin image loading
                img.crossOrigin = 'Anonymous';

                // Set up progress tracking on new song load
                const [minP, secP] = trackData.progress.split(':').map(Number);
                const [minD, secD] = trackData.duration ? trackData.duration.split(':').map(Number) : [0, 1];
                const totalProgressSeconds = (minP * 60) + secP;
                const totalDurationSeconds = (minD * 60) + secD;
                const initialProgressPercent = (totalDurationSeconds > 0) ? (totalProgressSeconds / totalDurationSeconds) * 100 : 0;

                setCurrentProgressPercent(initialProgressPercent);
                setLastUpdateTimestamp(Date.now());

                // Color Extraction
                img.onload = () => {
                    console.log("Image loaded successfully. Attempting ColorThief...");
                    try {
                        const dominantColor = colorThief.getColor(img);
                        const paletteColors = colorThief.getPalette(img, 5);
                        setPalette({
                            dominant: dominantColor,
                            accent1: paletteColors[1] || dominantColor,
                            accent2: paletteColors[2] || dominantColor,
                        });
                        console.log("ColorThief Succeeded. Extracted colors:", dominantColor);
                    } catch(e) {
                        console.error("ColorThief failed to extract colors (CORS or data issue):", e);
                        // Fallback palette if extraction fails
                        setPalette({ dominant: [255, 255, 255], accent1: [249, 115, 22], accent2: [239, 68, 68] });
                    }
                };
                img.onerror = () => {
                    console.error("Failed to load album art for color extraction. Check image URL and CORS headers.");
                    // Fallback palette if image load fails
                    setPalette({ dominant: [255, 255, 255], accent1: [249, 115, 22], accent2: [239, 68, 68] });
                };
                img.src = `${trackData.albumArt}?t=${Date.now()}`;
            }
        }, [trackData?.title, trackData?.albumArt]); // Depend on title/albumArt for new track

        // --- Progress Animation Loop (Unchanged) ---
        useEffect(() => {
            if (!trackData || !trackData.playing || !trackData.duration) return;

            const [minD, secD] = trackData.duration.split(':').map(Number);
            const totalDurationMs = ((minD * 60) + secD) * 1000;

            const animationInterval = setInterval(() => {
                const now = Date.now();
                const elapsedMsSinceLastApi = now - lastUpdateTimestamp;

                const [minP, secP] = trackData.progress.split(':').map(Number);
                const apiProgressMs = ((minP * 60) + secP) * 1000;

                const estimatedProgressMs = apiProgressMs + elapsedMsSinceLastApi;

                const newPercent = (estimatedProgressMs / totalDurationMs) * 100;

                if (newPercent >= 100) {
                    clearInterval(animationInterval);
                    setCurrentProgressPercent(100);
                    return;
                }

                setCurrentProgressPercent(newPercent);
            }, 1000);

            return () => clearInterval(animationInterval);
        }, [trackData, lastUpdateTimestamp]);


        // --- Styling Variable setup (Uses palette state) ---
        const dominantRgb = palette?.dominant ? palette.dominant.join(',') : '255, 255, 255';
        const accent1Rgb = palette?.accent1 ? palette.accent1.join(',') : '249,115,22';
        const accent2Rgb = palette?.accent2 ? palette.accent2.join(',') : '239,68,68';

        // Calculate a darker version of the dominant color for the base background
        const dominantDarkRgb = palette?.dominant ? darkenRgb(palette.dominant, 0.1).join(',') : '3, 7, 18';

        // --- Dynamic CSS Variable Update (DEPENDS on palette state) ---
        useEffect(() => {
            // New: Set the base background color of the body to a darker version of the dominant color
            document.body.style.setProperty('--dynamic-bg-color', `rgb(${dominantDarkRgb})`);

            // Background Aurora
            document.body.style.setProperty('--aurora-gradient-1', `linear-gradient(315deg, rgba(${dominantRgb}, 0.8) 0%, rgba(${accent1Rgb}, 0.6) 74%)`);
            document.body.style.setProperty('--aurora-gradient-2', `linear-gradient(45deg, rgba(${accent1Rgb}, 0.7) 0%, rgba(${accent2Rgb}, 0.5) 74%)`);

            // Text Glow (Thematic)
            document.body.style.setProperty('--text-glow-color', `rgba(${dominantRgb}, 0.8)`);

            // Album Art Glow (Thematic)
            document.body.style.setProperty('--album-art-glow-color', `rgba(${accent1Rgb}, 0.7)`);

            // Progress Bar Glow (Thematic)
            document.body.style.setProperty('--progress-glow-color', `rgba(${dominantRgb}, 0.9)`);

        }, [dominantRgb, accent1Rgb, accent2Rgb, palette, dominantDarkRgb]);


        // --- Handlers for Loading/Error States (Unchanged) ---
        if (isLoading) {
            return (
                <div className="min-h-screen flex flex-col justify-center items-center text-white p-8 text-glow">
                    <div className="animate-pulse text-5xl font-extrabold">...LOADING TRACK DATA...</div>
                </div>
            );
        }

        if (error) {
            return (
                <div className="min-h-screen flex flex-col justify-center items-center text-white p-8 text-glow" style={{ backgroundColor: 'rgba(128, 0, 0, 0.5)' }}>
                    <h1 className="text-5xl font-extrabold mb-4">ðŸš¨ API ERROR ðŸš¨</h1>
                    <p className="text-3xl text-red-300 text-center">Could not fetch data from your API.</p>
                </div>
            );
        }

        if (!trackData || !trackData.playing) {
            return (
                <div className="min-h-screen flex flex-col justify-center items-center text-white p-8 text-glow">
                    <h1 className="text-6xl font-extrabold mb-4">ðŸ˜´ Speakers Quiet ðŸ¤«</h1>
                    <p className="text-3xl text-gray-300">Nothing playing right now. Check back!</p>
                </div>
            );
        }

        // --- Track is Playing ---
        const { title, artist, album, albumArt, duration, next, isManual } = trackData;

        // Helper function to format time (in seconds) to MM:SS
        const formatTime = (totalSeconds) => {
            if (isNaN(totalSeconds) || totalSeconds < 0) return '0:00';
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };

        // Recalculate progress/duration for display from seconds/percent
        const [minD, secD] = duration ? duration.split(':').map(Number) : [0, 1];
        const totalDurationSeconds = (minD * 60) + secD;
        const estimatedProgressSeconds = (currentProgressPercent / 100) * totalDurationSeconds;
        const displayProgress = formatTime(estimatedProgressSeconds);


        return (
            <div className="min-h-screen flex items-center justify-center relative p-8">
                {/* Content Container - No Card Styles */}
                <div className="now-playing-content">
                    <div className="flex flex-col items-center md:flex-row gap-8 md:gap-12 w-full">

                        {/* Album Art & Tags */}
                        <div className="flex-shrink-0 relative w-full max-w-sm md:max-w-none md:w-96">
                            {albumArt && (
                                <>
                                    <img
                                        src={albumArt}
                                        alt={`Album art for ${album}`}
                                        className="w-full aspect-square rounded-3xl shadow-2xl album-art-glow"
                                        loading="eager"
                                        crossOrigin="anonymous" /* Added crossOrigin to the rendered image too */
                                    />
                                    {isManual && (
                                        <span className="manual-play-tag absolute top-6 right-6 text-xl px-5 py-2 rounded-full shadow-2xl">
                                            ðŸ’¿ CD/VINYL
                                        </span>
                                    )}
                                </>
                            )}
                        </div>

                        {/* Track Info */}
                        <div className="flex flex-col justify-center flex-grow w-full text-glow">
                            <p className="text-2xl font-extrabold text-white uppercase tracking-widest mb-4">
                                ðŸŽ¶ NOW PLAYING
                            </p>
                            <h2 className="text-6xl lg:text-7xl xl:text-8xl font-black tracking-tight leading-none mb-3 break-words text-white">
                                {title}
                            </h2>
                            <h3 className="text-4xl lg:text-5xl font-semibold text-gray-200 mb-6 break-words">
                                {artist}
                            </h3>
                            <p className="text-2xl text-gray-300 italic mb-8">
                                from **{album}**
                            </p>

                            {/* Progress Bar */}
                            {duration && (
                                <div className="mt-4 mb-8">
                                    <div className="h-4 rounded-full bg-white/20 overflow-hidden">
                                        <div
                                            className="progress-bar-fill h-full rounded-full transition-all duration-1000 ease-linear"
                                            style={{
                                                width: `${currentProgressPercent}%`,
                                                // Set the actual background color here using the dominant color
                                                backgroundColor: `rgb(${dominantRgb})`,
                                            }}
                                        ></div>
                                    </div>
                                    {/* Display animated progress time */}
                                    <div className="flex justify-between text-2xl font-bold mt-3 text-white">
                                        <span>{displayProgress}</span>
                                        <span>{duration}</span>
                                    </div>
                                </div>
                            )}

                            {/* Next Up Info */}
                            {next && (
                                <p className="mt-6 pt-6 border-t border-white/40 text-3xl text-gray-200">
                                    <span className="font-extrabold text-white">NEXT:</span> <span className="font-light">{next}</span>
                                </p>
                            )}

                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- Render the App ---
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<NowPlayingSite />);
</script>
</body>
</html>